<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Convertir CSV Mensajes Foro a SQL</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 900px;
      width: 100%;
      padding: 40px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .section {
      margin-bottom: 30px;
    }

    label {
      display: block;
      color: #495057;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    textarea {
      width: 100%;
      min-height: 200px;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 14px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s;
      margin-bottom: 10px;
    }

    .btn:hover {
      background: #5a67d8;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #48bb78;
    }

    .btn-secondary:hover {
      background: #38a169;
    }

    .result {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .result.visible {
      display: block;
    }

    .result textarea {
      background: #1a202c;
      color: #e2e8f0;
      border: none;
      min-height: 300px;
    }

    .stats {
      background: #e6f7ff;
      border: 2px solid #91d5ff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: none;
    }

    .stats.visible {
      display: block;
    }

    .stats strong {
      color: #0050b3;
    }

    .alert {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>ðŸ’¬ Convertir CSV de Mensajes Foro a SQL</h1>
  <p class="subtitle">Pega tu CSV de mensajes del foro y obtendrÃ¡s el script SQL listo para Supabase</p>

  <div class="alert">
    <strong>ðŸ“‹ Formato esperado:</strong><br>
    Chapa,Mensaje,Fecha,Editado<br>
    702,Hola a todos,2024-01-15 10:30:00,false<br>
    537,Buen dÃ­a compaÃ±eros,2024-01-15 11:45:00,false<br>
    ...<br><br>
    <strong>Nota:</strong> La columna "Editado" es opcional. Las fechas deben estar en formato YYYY-MM-DD HH:MM:SS o DD/MM/YYYY HH:MM:SS
  </div>

  <div class="section">
    <label>1. Pega aquÃ­ el contenido de tu CSV de mensajes del foro:</label>
    <textarea id="csvInput" placeholder="Chapa,Mensaje,Fecha,Editado
702,Hola a todos,2024-01-15 10:30:00,false
537,Buen dÃ­a compaÃ±eros,2024-01-15 11:45:00,false
918,Â¿Alguien sabe las puertas de hoy?,2024-01-15 12:00:00,false
..."></textarea>
  </div>

  <button class="btn" onclick="convertir()">ðŸš€ Convertir a SQL</button>

  <div class="stats" id="stats"></div>

  <div class="result" id="resultSection">
    <label>2. Script SQL generado (cÃ³pialo y pÃ©galo en Supabase SQL Editor):</label>
    <textarea id="sqlOutput" readonly></textarea>
    <button class="btn btn-secondary" onclick="copiarSQL()">ðŸ“‹ Copiar SQL</button>
  </div>
</div>

<script>
function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];

    if (char === '"') {
      if (inQuotes && line[i + 1] === '"') {
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === ',' && !inQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }

  result.push(current.trim());
  return result;
}

function convertirFecha(fechaStr) {
  if (!fechaStr || fechaStr.trim() === '') {
    return 'NOW()';
  }

  // Limpiar el string
  fechaStr = fechaStr.trim();

  // Formato DD/MM/YYYY HH:MM:SS
  const regex1 = /^(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
  const match1 = fechaStr.match(regex1);
  if (match1) {
    const [, dia, mes, aÃ±o, hora, min, seg] = match1;
    return `'${aÃ±o}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')} ${hora.padStart(2, '0')}:${min.padStart(2, '0')}:${seg.padStart(2, '0')}'`;
  }

  // Formato YYYY-MM-DD HH:MM:SS
  const regex2 = /^(\d{4})-(\d{1,2})-(\d{1,2})\s+(\d{1,2}):(\d{1,2}):(\d{1,2})$/;
  const match2 = fechaStr.match(regex2);
  if (match2) {
    const [, aÃ±o, mes, dia, hora, min, seg] = match2;
    return `'${aÃ±o}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')} ${hora.padStart(2, '0')}:${min.padStart(2, '0')}:${seg.padStart(2, '0')}'`;
  }

  // Si no coincide con ningÃºn formato, usar NOW()
  console.warn('Formato de fecha no reconocido:', fechaStr);
  return 'NOW()';
}

function convertir() {
  const csv = document.getElementById('csvInput').value.trim();

  if (!csv) {
    alert('Por favor, pega el contenido del CSV');
    return;
  }

  try {
    const lines = csv.split('\n');

    // Saltar la primera lÃ­nea (cabecera)
    const dataLines = lines.slice(1).filter(line => line.trim() !== '');

    if (dataLines.length === 0) {
      alert('No se encontraron datos en el CSV');
      return;
    }

    // Generar SQL
    let sql = `-- ============================================================================
-- IMPORTACIÃ“N DE MENSAJES DEL FORO DESDE GOOGLE SHEETS
-- ============================================================================
-- Total de mensajes: ${dataLines.length}
-- Ejecutar en: Supabase SQL Editor
-- ============================================================================

-- Limpiar tabla mensajes_foro (opcional - comenta esta lÃ­nea si quieres mantener mensajes existentes)
-- TRUNCATE TABLE mensajes_foro CASCADE;

-- Insertar mensajes del foro
INSERT INTO mensajes_foro (chapa, texto, timestamp, editado) VALUES\n`;

    const values = [];
    let errores = 0;

    dataLines.forEach((line, index) => {
      const parts = parseCSVLine(line);

      const chapa = parts[0] ? parts[0].replace(/^"|"$/g, '').trim() : '';
      const mensaje = parts[1] ? parts[1].replace(/^"|"$/g, '').trim() : '';
      const fecha = parts[2] ? parts[2].replace(/^"|"$/g, '').trim() : '';
      const editadoStr = parts[3] ? parts[3].replace(/^"|"$/g, '').trim().toLowerCase() : 'false';

      if (!chapa || !mensaje) {
        console.warn(`LÃ­nea ${index + 2} ignorada (falta chapa o mensaje):`, line);
        errores++;
        return;
      }

      // Escapar comillas simples en los valores
      const mensajeEsc = mensaje.replace(/'/g, "''");
      const editado = (editadoStr === 'true' || editadoStr === '1' || editadoStr === 'sÃ­' || editadoStr === 'si');
      const timestampSQL = convertirFecha(fecha);

      values.push(`  ('${chapa}', '${mensajeEsc}', ${timestampSQL}, ${editado})`);
    });

    if (values.length === 0) {
      alert('No se encontraron mensajes vÃ¡lidos en el CSV');
      return;
    }

    sql += values.join(',\n');
    sql += `
ON CONFLICT (id) DO NOTHING;

-- Verificar resultado
SELECT COUNT(*) as total_mensajes FROM mensajes_foro;

-- Ver los Ãºltimos 20 mensajes
SELECT chapa, LEFT(texto, 50) as mensaje_preview, timestamp, editado
FROM mensajes_foro
ORDER BY timestamp DESC
LIMIT 20;`;

    // Mostrar resultado
    document.getElementById('sqlOutput').value = sql;
    document.getElementById('resultSection').classList.add('visible');

    // Mostrar estadÃ­sticas
    const statsHtml = `
      <strong>âœ… ConversiÃ³n exitosa</strong><br>
      ðŸ“Š Mensajes encontrados: ${dataLines.length}<br>
      ðŸ“Š Mensajes vÃ¡lidos: ${values.length}<br>
      ${errores > 0 ? `âš ï¸ LÃ­neas con errores: ${errores}` : ''}
    `;
    document.getElementById('stats').innerHTML = statsHtml;
    document.getElementById('stats').classList.add('visible');

  } catch (error) {
    alert('Error al convertir CSV: ' + error.message);
    console.error(error);
  }
}

function copiarSQL() {
  const sqlOutput = document.getElementById('sqlOutput');
  sqlOutput.select();
  document.execCommand('copy');

  // Cambiar texto del botÃ³n temporalmente
  const btn = event.target;
  const textoOriginal = btn.textContent;
  btn.textContent = 'âœ… Copiado!';
  btn.style.background = '#38a169';

  setTimeout(() => {
    btn.textContent = textoOriginal;
    btn.style.background = '#48bb78';
  }, 2000);
}
</script>

</body>
</html>

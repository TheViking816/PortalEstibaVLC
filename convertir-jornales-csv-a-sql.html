<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Convertir CSV Jornales a SQL</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 900px;
      width: 100%;
      padding: 40px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .section {
      margin-bottom: 30px;
    }

    label {
      display: block;
      color: #495057;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    textarea {
      width: 100%;
      min-height: 200px;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 14px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s;
      margin-bottom: 10px;
    }

    .btn:hover {
      background: #5a67d8;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #48bb78;
    }

    .btn-secondary:hover {
      background: #38a169;
    }

    .result {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .result.visible {
      display: block;
    }

    .result textarea {
      background: #1a202c;
      color: #e2e8f0;
      border: none;
      min-height: 300px;
    }

    .stats {
      background: #e6f7ff;
      border: 2px solid #91d5ff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: none;
    }

    .stats.visible {
      display: block;
    }

    .stats strong {
      color: #0050b3;
    }

    .alert {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .alert-info {
      background: #d1ecf1;
      border-color: #17a2b8;
      color: #0c5460;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>ðŸ”„ Convertir CSV de Jornales a SQL</h1>
  <p class="subtitle">Pega tu CSV de jornales y obtendrÃ¡s el script SQL listo para Supabase</p>

  <div class="alert alert-info">
    <strong>ðŸ“‹ Formato esperado:</strong><br>
    Fecha,Chapa,Puesto_Contratacion,Jornada,Empresa,Buque,Parte,...<br>
    31/10/2024,702,MecÃ¡nico,completa,CPE,Buque1,M,...
  </div>

  <div class="section">
    <label>1. Pega aquÃ­ el contenido de tu CSV de jornales:</label>
    <textarea id="csvInput" placeholder="Fecha,Chapa,Puesto_Contratacion,Jornada,Empresa,Buque,Parte
31/10/2024,702,MecÃ¡nico,completa,CPE,Buque1,M
..."></textarea>
  </div>

  <button class="btn" onclick="convertir()">ðŸš€ Convertir a SQL</button>

  <div class="stats" id="stats"></div>

  <div class="result" id="resultSection">
    <label>2. Script SQL generado (cÃ³pialo y pÃ©galo en Supabase SQL Editor):</label>
    <textarea id="sqlOutput" readonly></textarea>
    <button class="btn btn-secondary" onclick="copiarSQL()">ðŸ“‹ Copiar SQL</button>
  </div>
</div>

<script>
// ============================================================================
// UTILIDADES
// ============================================================================

function convertirFecha(fechaStr) {
  if (!fechaStr || fechaStr.trim() === '') return null;

  // Si ya estÃ¡ en formato YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}$/.test(fechaStr)) {
    return fechaStr;
  }

  // Si estÃ¡ en formato DD/MM/YYYY
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(fechaStr)) {
    const [dia, mes, anio] = fechaStr.split('/');
    return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
  }

  // Intentar parsear como fecha
  const fecha = new Date(fechaStr);
  if (!isNaN(fecha.getTime())) {
    const anio = fecha.getFullYear();
    const mes = String(fecha.getMonth() + 1).padStart(2, '0');
    const dia = String(fecha.getDate()).padStart(2, '0');
    return `${anio}-${mes}-${dia}`;
  }

  return null;
}

function parseCSV(csv) {
  if (!csv || csv.trim() === '') return [];

  const lines = csv.split('\n').filter(line => line.trim() !== '');
  if (lines.length === 0) return [];

  const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
  const data = [];

  for (let i = 1; i < lines.length; i++) {
    const values = parseCSVLine(lines[i]);
    if (values.length === 0) continue;

    const row = {};
    headers.forEach((header, index) => {
      row[header] = values[index] || '';
    });
    data.push(row);
  }

  return data;
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    const nextChar = line[i + 1];

    if (char === '"') {
      if (inQuotes && nextChar === '"') {
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === ',' && !inQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }

  result.push(current.trim());
  return result;
}

// ============================================================================
// CONVERSIÃ“N
// ============================================================================

function convertir() {
  const csv = document.getElementById('csvInput').value.trim();

  if (!csv) {
    alert('Por favor, pega el contenido del CSV');
    return;
  }

  try {
    const data = parseCSV(csv);

    if (data.length === 0) {
      alert('No se encontraron datos en el CSV');
      return;
    }

    console.log('Primeras filas del CSV:', data.slice(0, 3));

    // Generar SQL
    let sql = `-- ============================================================================
-- IMPORTACIÃ“N DE JORNALES DESDE GOOGLE SHEETS
-- ============================================================================
-- Total de jornales: ${data.length}
-- Ejecutar en: Supabase SQL Editor
-- ============================================================================

-- Limpiar tabla jornales (opcional - comenta esta lÃ­nea si quieres mantener jornales existentes)
-- TRUNCATE TABLE jornales CASCADE;

-- Insertar jornales
INSERT INTO jornales (fecha, chapa, puesto, jornada, empresa, buque, parte, origen) VALUES\n`;

    const values = [];
    let errores = 0;

    data.forEach((row, index) => {
      // Mapear columnas del CSV a la tabla
      const fechaOriginal = row.Fecha || row.fecha;
      const fecha = convertirFecha(fechaOriginal);

      const chapa = (row.Chapa || row.chapa || '').toString().trim();
      const puesto = (row.Puesto_Contratacion || row.Puesto || row.puesto || '').trim();
      const jornada = (row.Jornada || row.jornada || '').trim();
      const empresa = (row.Empresa || row.empresa || '').trim();
      const buque = (row.Buque || row.buque || '').trim();
      const parte = (row.Parte || row.parte || '').trim();

      // Validar que tenga fecha y chapa mÃ­nimo
      if (!fecha || !chapa) {
        console.warn(`LÃ­nea ${index + 2} ignorada (falta fecha o chapa):`, row);
        errores++;
        return;
      }

      // Escapar comillas simples
      const puestoEsc = puesto.replace(/'/g, "''");
      const jornadaEsc = jornada.replace(/'/g, "''");
      const empresaEsc = empresa.replace(/'/g, "''");
      const buqueEsc = buque.replace(/'/g, "''");
      const parteEsc = parte.replace(/'/g, "''");

      values.push(`  ('${fecha}', '${chapa}', ${puesto ? "'" + puestoEsc + "'" : 'NULL'}, ${jornada ? "'" + jornadaEsc + "'" : 'NULL'}, ${empresa ? "'" + empresaEsc + "'" : 'NULL'}, ${buque ? "'" + buqueEsc + "'" : 'NULL'}, ${parte ? "'" + parteEsc + "'" : 'NULL'}, 'importacion')`);
    });

    if (values.length === 0) {
      alert('No se encontraron jornales vÃ¡lidos para importar');
      return;
    }

    sql += values.join(',\n');
    sql += `;\n\n-- Verificar resultado
SELECT COUNT(*) as total_jornales FROM jornales WHERE origen = 'importacion';

-- Ver los primeros 10 jornales
SELECT fecha, chapa, puesto, jornada, empresa
FROM jornales
ORDER BY fecha DESC
LIMIT 10;`;

    // Mostrar resultado
    document.getElementById('sqlOutput').value = sql;
    document.getElementById('resultSection').classList.add('visible');

    // Mostrar estadÃ­sticas
    const statsHtml = `
      <strong>âœ… ConversiÃ³n exitosa</strong><br>
      ðŸ“Š Jornales encontrados en CSV: ${data.length}<br>
      ðŸ“Š Jornales vÃ¡lidos: ${values.length}<br>
      ${errores > 0 ? `âš ï¸ LÃ­neas ignoradas: ${errores}` : ''}
    `;
    document.getElementById('stats').innerHTML = statsHtml;
    document.getElementById('stats').classList.add('visible');

  } catch (error) {
    alert('Error al convertir CSV: ' + error.message);
    console.error(error);
  }
}

function copiarSQL() {
  const sqlOutput = document.getElementById('sqlOutput');
  sqlOutput.select();
  document.execCommand('copy');

  // Cambiar texto del botÃ³n temporalmente
  const btn = event.target;
  const textoOriginal = btn.textContent;
  btn.textContent = 'âœ… Copiado!';
  btn.style.background = '#38a169';

  setTimeout(() => {
    btn.textContent = textoOriginal;
    btn.style.background = '#48bb78';
  }, 2000);
}
</script>

</body>
</html>

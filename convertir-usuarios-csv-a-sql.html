<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Convertir CSV Usuarios a SQL</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 900px;
      width: 100%;
      padding: 40px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .section {
      margin-bottom: 30px;
    }

    label {
      display: block;
      color: #495057;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    textarea {
      width: 100%;
      min-height: 200px;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 14px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s;
      margin-bottom: 10px;
    }

    .btn:hover {
      background: #5a67d8;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #48bb78;
    }

    .btn-secondary:hover {
      background: #38a169;
    }

    .result {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .result.visible {
      display: block;
    }

    .result textarea {
      background: #1a202c;
      color: #e2e8f0;
      border: none;
      min-height: 300px;
    }

    .stats {
      background: #e6f7ff;
      border: 2px solid #91d5ff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: none;
    }

    .stats.visible {
      display: block;
    }

    .stats strong {
      color: #0050b3;
    }

    .alert {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>ðŸ”„ Convertir CSV de Usuarios a SQL</h1>
  <p class="subtitle">Pega tu CSV de usuarios y obtendrÃ¡s el script SQL listo para Supabase</p>

  <div class="alert">
    <strong>ðŸ“‹ Formato esperado:</strong><br>
    contraseÃ±a,Chapa,Nombre<br>
    Albert1805,702,<br>
    MirVane,537,<br>
    ...
  </div>

  <div class="section">
    <label>1. Pega aquÃ­ el contenido de tu CSV de usuarios:</label>
    <textarea id="csvInput" placeholder="contraseÃ±a,Chapa,Nombre
Albert1805,702,
MirVane,537,
8022dwk,918,
..."></textarea>
  </div>

  <button class="btn" onclick="convertir()">ðŸš€ Convertir a SQL</button>

  <div class="stats" id="stats"></div>

  <div class="result" id="resultSection">
    <label>2. Script SQL generado (cÃ³pialo y pÃ©galo en Supabase SQL Editor):</label>
    <textarea id="sqlOutput" readonly></textarea>
    <button class="btn btn-secondary" onclick="copiarSQL()">ðŸ“‹ Copiar SQL</button>
  </div>
</div>

<script>
function convertir() {
  const csv = document.getElementById('csvInput').value.trim();

  if (!csv) {
    alert('Por favor, pega el contenido del CSV');
    return;
  }

  try {
    const lines = csv.split('\n');

    // Saltar la primera lÃ­nea (cabecera)
    const dataLines = lines.slice(1).filter(line => line.trim() !== '');

    if (dataLines.length === 0) {
      alert('No se encontraron datos en el CSV');
      return;
    }

    // Generar SQL
    let sql = `-- ============================================================================
-- IMPORTACIÃ“N DE USUARIOS DESDE GOOGLE SHEETS
-- ============================================================================
-- Total de usuarios: ${dataLines.length}
-- Ejecutar en: Supabase SQL Editor
-- ============================================================================

-- Limpiar tabla usuarios (opcional - comenta esta lÃ­nea si quieres mantener usuarios existentes)
-- TRUNCATE TABLE usuarios CASCADE;

-- Insertar usuarios
INSERT INTO usuarios (password_hash, chapa, nombre, activo) VALUES\n`;

    const values = [];

    dataLines.forEach((line, index) => {
      // Parsear CSV (manejar comillas y comas)
      const parts = line.split(',').map(p => p.trim().replace(/^"|"$/g, ''));

      const password = parts[0] || '';
      const chapa = parts[1] || '';
      const nombre = parts[2] || '';

      if (!chapa || !password) {
        console.warn(`LÃ­nea ${index + 2} ignorada (falta chapa o contraseÃ±a):`, line);
        return;
      }

      // Escapar comillas simples en los valores
      const passwordEsc = password.replace(/'/g, "''");
      const nombreEsc = nombre.replace(/'/g, "''");

      values.push(`  ('${passwordEsc}', '${chapa}', ${nombre ? "'" + nombreEsc + "'" : 'NULL'}, true)`);
    });

    sql += values.join(',\n');
    sql += `\nON CONFLICT (chapa) DO UPDATE SET
  password_hash = EXCLUDED.password_hash,
  nombre = COALESCE(EXCLUDED.nombre, usuarios.nombre),
  activo = true;

-- Verificar resultado
SELECT COUNT(*) as total_usuarios FROM usuarios WHERE activo = true;

-- Ver los primeros 10 usuarios
SELECT chapa, nombre, activo, created_at
FROM usuarios
WHERE activo = true
ORDER BY chapa
LIMIT 10;`;

    // Mostrar resultado
    document.getElementById('sqlOutput').value = sql;
    document.getElementById('resultSection').classList.add('visible');

    // Mostrar estadÃ­sticas
    const statsHtml = `
      <strong>âœ… ConversiÃ³n exitosa</strong><br>
      ðŸ“Š Usuarios encontrados: ${dataLines.length}<br>
      ðŸ“Š Usuarios vÃ¡lidos: ${values.length}<br>
      ${dataLines.length !== values.length ? `âš ï¸ LÃ­neas ignoradas: ${dataLines.length - values.length}` : ''}
    `;
    document.getElementById('stats').innerHTML = statsHtml;
    document.getElementById('stats').classList.add('visible');

  } catch (error) {
    alert('Error al convertir CSV: ' + error.message);
    console.error(error);
  }
}

function copiarSQL() {
  const sqlOutput = document.getElementById('sqlOutput');
  sqlOutput.select();
  document.execCommand('copy');

  // Cambiar texto del botÃ³n temporalmente
  const btn = event.target;
  const textoOriginal = btn.textContent;
  btn.textContent = 'âœ… Copiado!';
  btn.style.background = '#38a169';

  setTimeout(() => {
    btn.textContent = textoOriginal;
    btn.style.background = '#48bb78';
  }, 2000);
}
</script>

</body>
</html>

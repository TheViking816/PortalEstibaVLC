<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Verificar Sistema Premium</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { color: #0a2e5c; }
    .test-section { margin: 20px 0; padding: 20px; background: #f9f9f9; border-radius: 8px; }
    button { padding: 10px 20px; background: #0a2e5c; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
    button:hover { background: #163d6f; }
    .result { margin-top: 10px; padding: 10px; background: white; border-left: 4px solid #0a2e5c; }
    .success { border-left-color: #10b981; }
    .error { border-left-color: #ef4444; }
    pre { background: #f3f4f6; padding: 10px; border-radius: 4px; overflow-x: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Verificar Sistema Premium</h1>

    <div class="test-section">
      <h2>1. Verificar Conexi√≥n Supabase</h2>
      <button onclick="testSupabase()">Probar Conexi√≥n</button>
      <div id="supabase-result"></div>
    </div>

    <div class="test-section">
      <h2>2. Verificar Tabla usuarios_premium</h2>
      <button onclick="testTable()">Verificar Tabla</button>
      <div id="table-result"></div>
    </div>

    <div class="test-section">
      <h2>3. Verificar Funci√≥n RPC tiene_acceso_premium</h2>
      <input type="text" id="chapa-test" placeholder="Chapa (ej: 816)" value="816">
      <button onclick="testRPC()">Probar RPC</button>
      <div id="rpc-result"></div>
    </div>

    <div class="test-section">
      <h2>4. Insertar Usuario de Prueba</h2>
      <input type="text" id="chapa-insert" placeholder="Chapa" value="768">
      <button onclick="insertTestUser()">Insertar Usuario Premium</button>
      <div id="insert-result"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://icszzxkdxatfytpmoviq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imljc3p6eGtkeGF0Znl0cG1vdmlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2Mzk2NjUsImV4cCI6MjA3ODIxNTY2NX0.hmQWNB3sCyBh39gdNgQLjjlIvliwJje-OYf0kkPObVA';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function testSupabase() {
      const result = document.getElementById('supabase-result');
      result.innerHTML = '<p>‚è≥ Probando conexi√≥n...</p>';

      try {
        const { data, error } = await supabase.from('usuarios').select('count').limit(1);

        if (error) throw error;

        result.innerHTML = `<div class="result success">
          <strong>‚úÖ Conexi√≥n exitosa!</strong>
          <p>Supabase est√° conectado correctamente.</p>
        </div>`;
      } catch (error) {
        result.innerHTML = `<div class="result error">
          <strong>‚ùå Error de conexi√≥n</strong>
          <pre>${error.message}</pre>
        </div>`;
      }
    }

    async function testTable() {
      const result = document.getElementById('table-result');
      result.innerHTML = '<p>‚è≥ Verificando tabla...</p>';

      try {
        const { data, error } = await supabase.from('usuarios_premium').select('*');

        if (error) throw error;

        result.innerHTML = `<div class="result success">
          <strong>‚úÖ Tabla existe!</strong>
          <p>Encontrados ${data.length} registros en usuarios_premium:</p>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        </div>`;
      } catch (error) {
        result.innerHTML = `<div class="result error">
          <strong>‚ùå Error accediendo a tabla</strong>
          <p>Mensaje: ${error.message}</p>
          <p><strong>Soluci√≥n:</strong> Necesitas ejecutar el SQL en Supabase Dashboard ‚Üí SQL Editor</p>
          <p>Archivo: <code>sql/freemium_system.sql</code></p>
        </div>`;
      }
    }

    async function testRPC() {
      const result = document.getElementById('rpc-result');
      const chapa = document.getElementById('chapa-test').value;
      result.innerHTML = '<p>‚è≥ Probando funci√≥n RPC...</p>';

      try {
        const { data, error } = await supabase.rpc('tiene_acceso_premium', {
          chapa_usuario: chapa
        });

        if (error) throw error;

        result.innerHTML = `<div class="result success">
          <strong>‚úÖ Funci√≥n RPC funciona!</strong>
          <p>Chapa <strong>${chapa}</strong> tiene acceso premium: <strong>${data ? 'S√ç' : 'NO'}</strong></p>
        </div>`;
      } catch (error) {
        result.innerHTML = `<div class="result error">
          <strong>‚ùå Error en funci√≥n RPC</strong>
          <pre>${error.message}</pre>
          <p><strong>Soluci√≥n:</strong> La funci√≥n RPC no existe. Ejecuta el SQL completo.</p>
        </div>`;
      }
    }

    async function insertTestUser() {
      const result = document.getElementById('insert-result');
      const chapa = document.getElementById('chapa-insert').value;
      result.innerHTML = '<p>‚è≥ Insertando usuario...</p>';

      try {
        const { data, error } = await supabase.from('usuarios_premium').upsert({
          chapa: chapa,
          plan_tipo: 'premium_mensual',
          estado: 'active',
          fecha_inicio: new Date().toISOString(),
          fecha_fin: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
          sueldometro_habilitado: true,
          oraculo_habilitado: true,
          chatbot_ia_habilitado: true
        });

        if (error) throw error;

        result.innerHTML = `<div class="result success">
          <strong>‚úÖ Usuario insertado!</strong>
          <p>Chapa <strong>${chapa}</strong> ahora tiene acceso premium por 30 d√≠as.</p>
        </div>`;
      } catch (error) {
        result.innerHTML = `<div class="result error">
          <strong>‚ùå Error insertando usuario</strong>
          <pre>${error.message}</pre>
        </div>`;
      }
    }
  </script>
</body>
</html>
